generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model User {
  id              String             @id @default(cuid())
  username     String             @unique
  email           String?            @unique
  password        String?
  googleId        String?            @unique
  isGuest         Boolean            @default(false)
  createdAt       DateTime           @default(now())


  // onboarding choice
  selectedLanguageId String? 
  selectedLanguage   Language?        @relation(fields: [selectedLanguageId], references: [id])
  
  // onboarding data
  learningGoal    LearningGoal?
  avatarId        String?
  onboardingCompleted Boolean @default(false)
  placementTestScore Int? // 0-5 score from placement test

  xp              Int                @default(0)
  hearts          Int                @default(5)
  streak          Int                @default(0)
  lastStreakDate  DateTime?          // Last day a lesson was completed
  lastActiveAt    DateTime?

  progresses      UserUnitProgress[]
  completedLessons UserLessonCompletion[]
  answers         UserAnswer[]
}

model Language {
  id        String     @id @default(cuid())
  name      String
  slug      String      @unique // e.g. python, java

  chapters  Chapter[]
  users     User[]
  placementTests PlacementTest[]
}

model Chapter {
  id          String   @id @default(cuid())
  title       String
  levelIndex  Int      // 1,2,3.... (harder every step)
  
  languageId  String
  language    Language  @relation(fields: [languageId], references: [id])

  units       Unit[]
}

model Unit {
  id          String   @id @default(cuid())
  title       String
  unitIndex   Int
  chapterId   String
  chapter     Chapter  @relation(fields: [chapterId], references: [id])

  lessons     Lesson[]

  userUnitProgresses UserUnitProgress[]
}

model Lesson {
  id        String   @id @default(cuid())
  lessonIndex Int
  hearts    Int      @default(3)  // hearts per lesson attempt

  title     String
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id])

  questions Question[]

  userLessonCompletions UserLessonCompletion[]
}

model Question {
  id            String        @id @default(cuid())
  type          QuestionType
  instruction   String
  description   String?

  // Debug Hunt
  codeSegments  CodeSegment[]

  // Multiple Choice / Predict Output / Line Repair
  codeBlock     String?
  options       QuestionOption[]

  // Reorder
  items         ReorderItem[]
  correctOrder  Int[]     // Now stored as array instead of string

  // Fill in Blank
  codeBefore    String?
  codeAfter     String?

  // Logic Puzzle
  logicCondition String?

  // Match Madness
  pairs         MatchPair[]

  explanation   String?
  difficulty    Int @default(1)

  lessonId      String
  lesson        Lesson @relation(fields: [lessonId], references: [id])

  userAnswers   UserAnswer[]
}

model CodeSegment {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  code       String
  isBug      Boolean        // SAME as JSON
  correction String?        // New: SAME as JSON
  index      Int

  @@index([questionId])
}

model QuestionOption {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text       String
  isCorrect  Boolean
  index      Int

  @@index([questionId])
}

model ReorderItem {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text       String
  index      Int

  @@index([questionId])
}

model MatchPair {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // JSON format is: { id, text, matchId }
  text       String      // original text
  matchId    String      // id of the matching pair

  index      Int

  @@index([questionId])
}

enum QuestionType {
  DEBUG_HUNT
  MULTIPLE_CHOICE
  REORDER
  FILL_BLANK
  PREDICT_OUTPUT
  LOGIC_PUZZLE
  MATCH_MADNESS
  LINE_REPAIR
}

enum LearningGoal {
  BEGINNER // Learn coding from zero
  IMPROVE  // Improve coding skills
  INTERVIEW // Prepare for interviews
}

model PlacementTest {
  id          String   @id @default(cuid())
  languageId  String
  language    Language @relation(fields: [languageId], references: [id])
  
  type        QuestionType
  content     String
  explanation String?
  choices     String[]
  answer      String
  difficulty  Int      @default(1)
}
// Progress â€” where user continues
//
model UserUnitProgress {
  id          String   @id @default(cuid())
  userId      String
  unitId      String
  isUnlocked  Boolean  @default(false)
  completed   Boolean  @default(false)
  progress    Int      @default(0) // percentage

  user        User   @relation(fields: [userId], references: [id])
  unit        Unit   @relation(fields: [unitId], references: [id])

  @@unique([userId, unitId])
}

model UserLessonCompletion {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  completed Boolean @default(false)
  hearts    Int     @default(3)   // current hearts in this lesson session
  attempts  Int     @default(0)   // number of failed attempts
  xpEarned  Int     @default(0)   // XP earned from this lesson
  completedAt DateTime?           // when lesson was completed

  user      User   @relation(fields: [userId], references: [id])
  lesson    Lesson @relation(fields: [lessonId], references: [id])
  
  @@unique([userId, lessonId])
}

model UserAnswer {
  id          String   @id @default(cuid())
  userId      String
  questionId  String
  isCorrect   Boolean
  selected    String?    // user's choice
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  question    Question @relation(fields: [questionId], references: [id])
}
