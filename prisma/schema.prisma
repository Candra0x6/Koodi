generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String                 @id @default(cuid())
  username            String                 @unique
  email               String?                @unique
  password            String?
  googleId            String?                @unique
  isGuest             Boolean                @default(false)
  createdAt           DateTime               @default(now())
  learningGoal        LearningGoal?
  avatarId            String?
  onboardingCompleted Boolean                @default(false)
  placementTestScore  Int?
  xp                  Int                    @default(0)
  gems                Int                    @default(0)
  hearts              Int                    @default(5)
  streak              Int                    @default(0)
  longestStreak       Int                    @default(0)
  lastStreakDate      DateTime?
  lastActiveAt        DateTime?
  dailyXpGoal         Int                    @default(50)
  lessonSessions      LessonSession[]
  missions            Mission[]
  answers             UserAnswer[]
  languageProgresses  UserLanguageProgress[]
  completedLessons    UserLessonCompletion[]
  questionHistories   UserQuestionHistory[]
  progresses          UserUnitProgress[]
  xpLogs              XPLog[]
}

model Language {
  id                   String                 @id @default(cuid())
  name                 String
  slug                 String                 @unique
  chapters             Chapter[]
  missions             Mission[]
  placementTests       PlacementTest[]
  questions            Question[]
  userLanguageProgress UserLanguageProgress[]
}

model UserLanguageProgress {
  id               String     @id @default(cuid())
  userId           String
  languageId       String
  currentChapterId String?
  skillLevel       SkillLevel @default(BEGINNER)
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  currentChapter   Chapter?   @relation(fields: [currentChapterId], references: [id])
  language         Language   @relation(fields: [languageId], references: [id])
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, languageId])
  @@index([userId])
  @@index([languageId])
}

model Chapter {
  id                           String                 @id @default(cuid())
  title                        String
  levelIndex                   Int
  languageId                   String
  language                     Language               @relation(fields: [languageId], references: [id])
  questions                    Question[]
  units                        Unit[]
  userLanguageProgressChapters UserLanguageProgress[]
}

model Unit {
  id                 String             @id @default(cuid())
  title              String
  unitIndex          Int
  chapterId          String
  lessons            Lesson[]
  chapter            Chapter            @relation(fields: [chapterId], references: [id])
  userUnitProgresses UserUnitProgress[]
}

model Lesson {
  id                    String                 @id @default(cuid())
  lessonIndex           Int
  hearts                Int                    @default(3)
  title                 String
  unitId                String
  type                  LessonType             @default(BOOK)
  questionCount         Int                    @default(5)
  targetDifficulty      DifficultyLevel        @default(EASY)
  selectionConfig       Json?
  unit                  Unit                   @relation(fields: [unitId], references: [id])
  lessonSessions        LessonSession[]
  userLessonCompletions UserLessonCompletion[]
}

model Question {
  id                    String                @id @default(cuid())
  type                  QuestionType
  instruction           String
  description           String?
  codeBlock             String?
  correctOrder          Int[]
  codeBefore            String?
  codeAfter             String?
  logicCondition        String?
  explanation           String?
  difficulty            DifficultyLevel       @default(EASY)
  languageId            String
  chapterId             String
  codeSegments          CodeSegment[]
  pairs                 MatchPair[]
  chapter               Chapter               @relation(fields: [chapterId], references: [id])
  language              Language              @relation(fields: [languageId], references: [id])
  options               QuestionOption[]
  items                 ReorderItem[]
  userAnswers           UserAnswer[]
  userQuestionHistories UserQuestionHistory[]
}

model CodeSegment {
  id         String   @id @default(cuid())
  questionId String
  code       String
  isBug      Boolean
  correction String?
  index      Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model QuestionOption {
  id         String   @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean
  index      Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model ReorderItem {
  id         String   @id @default(cuid())
  questionId String
  text       String
  index      Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model MatchPair {
  id         String   @id @default(cuid())
  questionId String
  text       String
  matchId    String
  index      Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model Mission {
  id           String          @id @default(cuid())
  userId       String
  type         MissionType
  category     MissionCategory
  goal         String
  targetCount  Int
  currentCount Int             @default(0)
  languageId   String?
  expiresAt    DateTime
  status       MissionStatus   @default(PENDING)
  claimedAt    DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  language     Language?       @relation(fields: [languageId], references: [id])
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward       MissionReward?

  @@index([userId])
  @@index([expiresAt])
  @@index([status])
}

model MissionReward {
  id           String   @id @default(cuid())
  missionId    String   @unique
  xp           Int      @default(0)
  gems         Int      @default(0)
  hearts       Int      @default(0)
  streakFreeze Int      @default(0)
  xpBooster    Int      @default(0)
  items        String[]
  mission      Mission  @relation(fields: [missionId], references: [id], onDelete: Cascade)
}

model XPLog {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  source    XPSource
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model PlacementTest {
  id          String       @id @default(cuid())
  languageId  String
  type        QuestionType
  content     String
  explanation String?
  choices     String[]
  answer      String
  difficulty  Int          @default(1)
  language    Language     @relation(fields: [languageId], references: [id])
}

model UserUnitProgress {
  id         String  @id @default(cuid())
  userId     String
  unitId     String
  isUnlocked Boolean @default(false)
  completed  Boolean @default(false)
  progress   Int     @default(0)
  unit       Unit    @relation(fields: [unitId], references: [id])
  user       User    @relation(fields: [userId], references: [id])

  @@unique([userId, unitId])
}

model UserLessonCompletion {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  hearts      Int       @default(3)
  attempts    Int       @default(0)
  xpEarned    Int       @default(0)
  completedAt DateTime?
  lesson      Lesson    @relation(fields: [lessonId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([userId, lessonId])
}

model UserAnswer {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  isCorrect  Boolean
  selected   String?
  createdAt  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model LessonSession {
  id          String    @id @default(cuid())
  lessonId    String
  userId      String
  questionIds String[]
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  heartsUsed  Int       @default(0)
  xpEarned    Int       @default(0)
  lesson      Lesson    @relation(fields: [lessonId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId, lessonId])
}

model UserQuestionHistory {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  attempts   Int      @default(0)
  correct    Int      @default(0)
  lastSeenAt DateTime @default(now())
  mastery    Float    @default(0)
  question   Question @relation(fields: [questionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, questionId])
  @@index([userId])
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  CHEST
  BOOK
  ACTIVE
  LOCKED
  STAR
  DUMBBELL
  TROPHY
  HEADPHONES
  ROLEPLAY
  VIDEO
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum QuestionType {
  DEBUG_HUNT
  MULTIPLE_CHOICE
  REORDER
  FILL_BLANK
  PREDICT_OUTPUT
  LOGIC_PUZZLE
  MATCH_MADNESS
  LINE_REPAIR
}

enum LearningGoal {
  BEGINNER
  IMPROVE
  INTERVIEW
}

enum MissionType {
  DAILY
  WEEKLY
  EVENT
}

enum MissionStatus {
  PENDING
  COMPLETED
  CLAIMED
}

enum MissionCategory {
  XP
  LESSON
  BUG_FIX
  PREDICT
  TIMED
  STORY
  ROLEPLAY
  VIDEO
  LOGIC
}

enum XPSource {
  LESSON
  MISSION
  STREAK
  PRACTICE
  BONUS
  ADMIN
}
